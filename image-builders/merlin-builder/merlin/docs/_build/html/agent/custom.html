

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Custom Build &mdash; Merlin BETA documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="JavaScript Agent" href="javascript.html" />
    <link rel="prev" title="PowerShell" href="powershell.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Merlin
          

          
          </a>

          
            
            
              <div class="version">
                0.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickStart/server.html">Merlin Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickStart/agent.html">Merlin Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickStart/faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Merlin Agent</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Flags</a></li>
<li class="toctree-l1"><a class="reference internal" href="dll.html">DLL Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="powershell.html">PowerShell</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Custom Build</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basic">Basic</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advanced">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="#windows-agent">Windows Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cross-compiling">Cross-Compiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mobile">Mobile</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="javascript.html">JavaScript Agent</a></li>
</ul>
<p class="caption"><span class="caption-text">Merlin Server</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../server/menu/main.html">Main Menu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/menu/agents.html">Agent Menu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/menu/listeners.html">Listener Menu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/menu/modules.html">Modules Menu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/x509.html">TLS Certificates</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/build.html">Building Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/blogs.html">Blog Posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/contrib.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/logging.html">Logging</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Merlin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Custom Build</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/agent/custom.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="custom-build">
<h1>Custom Build<a class="headerlink" href="#custom-build" title="Permalink to this headline">¶</a></h1>
<p>This section details how to build custom build a Merlin Agent using the Make file.</p>
<p><strong>NOTE:</strong> Merlin is distributed with pre-compiled agent binaries for all major platforms in the <code class="docutils literal notranslate"><span class="pre">data/bin</span></code> directory.</p>
<div class="section" id="basic">
<h2>Basic<a class="headerlink" href="#basic" title="Permalink to this headline">¶</a></h2>
<p>The provided Make file can be used to build a new agent from <strong>source</strong>. It is recommended that you first use
<code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">get</span> <span class="pre">github.com/Ne0nd0g/Merlin</span></code> to pull a copy of the Merlin source code to the host. Move into the Merlin root
directory where the Make file is located.</p>
<ul class="simple">
<li><p>Windows agent: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">agent-windows</span></code></p></li>
<li><p>Linux agent: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">agent-linux</span></code></p></li>
<li><p>macOS agent: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">agent-darwin</span></code></p></li>
<li><p>Windows DLL: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">agent-dll</span></code></p></li>
<li><p>MIPS agent: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">agent-mips</span></code></p></li>
<li><p>ARM agent: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">agent-arm</span></code></p></li>
</ul>
</div>
<div class="section" id="advanced">
<h2>Advanced<a class="headerlink" href="#advanced" title="Permalink to this headline">¶</a></h2>
<p>Use the provided Make file to build a Merlin Agent with hard coded values. This removes the need for an operator to use
commandline arguments and allows the Agent to simply be executed. The table below shows configurable compile options</p>
<table class="colwidths-auto docutils align-default" id="id1">
<caption><span class="caption-text">Build Options</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>URL</p></td>
<td><p>Full URL for agent to connect to (default “<a class="reference external" href="https://127.0.0.1:443">https://127.0.0.1:443</a>”)</p></td>
<td><p>same as the <code class="docutils literal notranslate"><span class="pre">-url</span></code> commandline flag</p></td>
</tr>
<tr class="row-odd"><td><p>PSK</p></td>
<td><p>Pre-Shared Key used to encrypt initial communications (default “merlin”)</p></td>
<td><p>same as <code class="docutils literal notranslate"><span class="pre">-psk</span></code> commandline flag</p></td>
</tr>
<tr class="row-even"><td><p>PROXY</p></td>
<td><p>Hardcoded proxy to use for http/1.1 traffic only that will override host configuration</p></td>
<td><p>same as <code class="docutils literal notranslate"><span class="pre">-proxy</span></code> commandline flag</p></td>
</tr>
<tr class="row-odd"><td><p>HOST</p></td>
<td><p>HTTP Host header</p></td>
<td><p>same as <code class="docutils literal notranslate"><span class="pre">-host</span></code> commandline flag</p></td>
</tr>
<tr class="row-even"><td><p>PROTO</p></td>
<td><p>Protocol for the agent to connect with [https (HTTP/1.1), http (HTTP/1.1 Clear-Text), h2 (HTTP/2), h2c (HTTP/2 Clear-Text), http3 (QUIC or HTTP/3.0)] (default ‘h2’)</p></td>
<td><p>same as <code class="docutils literal notranslate"><span class="pre">-proto</span></code> commandline flag</p></td>
</tr>
<tr class="row-odd"><td><p>JA3</p></td>
<td><p>JA3 signature string (not the MD5 hash). Overrides -proto flag</p></td>
<td><p>same as <code class="docutils literal notranslate"><span class="pre">-ja3</span></code> commandline flag</p></td>
</tr>
</tbody>
</table>
<p>An example of creating a new Linux HTTP agent that is using domain fronting through <code class="docutils literal notranslate"><span class="pre">https://merlin.com/c2endpoint.php</span></code> using a PSK of <code class="docutils literal notranslate"><span class="pre">SecurePassword1</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">agent-linux</span> <span class="pre">URL=https://merlin.com:443/c2endpoint.php</span> <span class="pre">HOST=myendpoint.azureedge.net</span> <span class="pre">PROTO=https</span> <span class="pre">PSK=SecurePassword1</span></code></p>
</div>
<div class="section" id="windows-agent">
<h2>Windows Agent<a class="headerlink" href="#windows-agent" title="Permalink to this headline">¶</a></h2>
<p>The Windows Merlin Agent executable is compiled as a GUI application instead of console application. The Merlin Agent
does not have a GUI component. The reason this is used is so that the Merlin Agent window disappears after it is executed.
This behavior is intentional so that the user will not see the application window. This is done with the LDFLAGS when
building the agent using the <code class="docutils literal notranslate"><span class="pre">-H=windowsgui</span></code> option as shown <a class="reference external" href="https://golang.org/cmd/link/">here</a></p>
<p>This causes problems when a user <strong>WANTS</strong> to see the Merlin Agent verbose or debug output. To view Merlin verbose/debug
output, recompile the agent after removing <code class="docutils literal notranslate"><span class="pre">-H=windowsgui</span></code> from the Make file. Alternatively, compile the Windows
agent with: <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">build</span> <span class="pre">-o</span> <span class="pre">Merlin.exe</span> <span class="pre">cmd/merlinagent/main.go</span></code>.</p>
</div>
<div class="section" id="cross-compiling">
<h2>Cross-Compiling<a class="headerlink" href="#cross-compiling" title="Permalink to this headline">¶</a></h2>
<p>The Merlin agent and server can be cross-compiled to any operating system or architecture.
A list of golang supported operating systems and architectures can be found here: <a class="reference external" href="https://golang.org/doc/install/source#environment">https://golang.org/doc/install/source#environment</a></p>
<table class="colwidths-auto docutils align-default" id="id2">
<caption><span class="caption-text">Supported Platforms</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>$GOOS</p></th>
<th class="head"><p>$GOARCH</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>android</p></td>
<td><p>arm</p></td>
</tr>
<tr class="row-odd"><td><p>darwin</p></td>
<td><p>386</p></td>
</tr>
<tr class="row-even"><td><p>darwin</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-odd"><td><p>darwin</p></td>
<td><p>arm</p></td>
</tr>
<tr class="row-even"><td><p>darwin</p></td>
<td><p>arm64</p></td>
</tr>
<tr class="row-odd"><td><p>dragonfly</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-even"><td><p>freebsd</p></td>
<td><p>386</p></td>
</tr>
<tr class="row-odd"><td><p>freebsd</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-even"><td><p>freebsd</p></td>
<td><p>arm</p></td>
</tr>
<tr class="row-odd"><td><p>linux</p></td>
<td><p>386</p></td>
</tr>
<tr class="row-even"><td><p>linux</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-odd"><td><p>linux</p></td>
<td><p>arm</p></td>
</tr>
<tr class="row-even"><td><p>linux</p></td>
<td><p>arm64</p></td>
</tr>
<tr class="row-odd"><td><p>linux</p></td>
<td><p>ppc64</p></td>
</tr>
<tr class="row-even"><td><p>linux</p></td>
<td><p>ppc64le</p></td>
</tr>
<tr class="row-odd"><td><p>linux</p></td>
<td><p>mips</p></td>
</tr>
<tr class="row-even"><td><p>linux</p></td>
<td><p>mipsle</p></td>
</tr>
<tr class="row-odd"><td><p>linux</p></td>
<td><p>mips64</p></td>
</tr>
<tr class="row-even"><td><p>linux</p></td>
<td><p>mips64le</p></td>
</tr>
<tr class="row-odd"><td><p>netbsd</p></td>
<td><p>386</p></td>
</tr>
<tr class="row-even"><td><p>netbsd</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-odd"><td><p>netbsd</p></td>
<td><p>arm</p></td>
</tr>
<tr class="row-even"><td><p>openbsd</p></td>
<td><p>386</p></td>
</tr>
<tr class="row-odd"><td><p>openbsd</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-even"><td><p>openbsd</p></td>
<td><p>arm</p></td>
</tr>
<tr class="row-odd"><td><p>plan9</p></td>
<td><p>386</p></td>
</tr>
<tr class="row-even"><td><p>plan9</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-odd"><td><p>solaris</p></td>
<td><p>amd64</p></td>
</tr>
<tr class="row-even"><td><p>windows</p></td>
<td><p>386</p></td>
</tr>
<tr class="row-odd"><td><p>windows</p></td>
<td><p>amd64</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="mobile">
<h2>Mobile<a class="headerlink" href="#mobile" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>The gomobile library can be used to compile for Android and iOS:</dt><dd><p><a class="reference external" href="https://godoc.org/golang.org/x/mobile/cmd/gomobile">https://godoc.org/golang.org/x/mobile/cmd/gomobile</a></p>
</dd>
</dl>
<p>These instructions can be followed to compile for Android</p>
<ul class="simple">
<li><p>Install Android SDK: <a class="reference external" href="https://developer.android.com/ndk/guides/index.html">https://developer.android.com/ndk/guides/index.html</a></p></li>
<li><dl class="simple">
<dt>Install gomobile:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">get</span> <span class="pre">golang.org/x/mobile/cmd/gomobile</span></code></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Initialize gomobile:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">bin\gomobile</span> <span class="pre">init</span> <span class="pre">-ndk=C:\Users\[username]\AppData\Local\Android\Sdk\ndk-bundle</span></code></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Build the APK:</dt><dd><p><code class="docutils literal notranslate"><span class="pre">bin\gomobile</span> <span class="pre">build</span> <span class="pre">-target=android</span> <span class="pre">merlinagent</span></code></p>
</dd>
</dl>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="javascript.html" class="btn btn-neutral float-right" title="JavaScript Agent" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="powershell.html" class="btn btn-neutral float-left" title="PowerShell" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Russel Van Tuyl (@Ne0nd0g)

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>